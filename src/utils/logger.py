# src/utils/logger.py
"""
Erweiterte Logging-Konfiguration mit sch√∂nen Formatierungen
F√ºr benutzerfreundliche und ansprechende Logs
"""

import os
import sys
import logging
from datetime import datetime
from pathlib import Path

class UnicodeFormatter(logging.Formatter):
    """Sch√∂ner Unicode-Formatter mit Emojis und besserer Lesbarkeit"""
    
    # Mapping von Log-Levels zu sch√∂nen Emojis und Beschreibungen
    LEVEL_STYLES = {
        'DEBUG': {'emoji': 'üîç', 'color': 'cyan', 'desc': 'Debug'},
        'INFO': {'emoji': 'üìù', 'color': 'green', 'desc': 'Info'},
        'WARNING': {'emoji': '‚ö†Ô∏è', 'color': 'yellow', 'desc': 'Warnung'},
        'ERROR': {'emoji': '‚ùå', 'color': 'red', 'desc': 'Fehler'},
        'CRITICAL': {'emoji': 'üí•', 'color': 'magenta', 'desc': 'Kritisch'},
    }
    
    # Spezielle Logger mit eigenen Emojis
    LOGGER_EMOJIS = {
        'discord.client': 'üîå',
        'discord.gateway': 'üåê',
        'discord.http': 'üì°',
        'src.bot': 'ü§ñ',
        'src.cogs': '‚öôÔ∏è',
        'src.utils': 'üõ†Ô∏è',
        'src.systems': 'üß†',
        'src.systems.migration_system': 'üíæ',
        'src.systems.command_registration_system': 'üéØ',
        'alembic': 'üîÑ',
        'asyncpg': 'üêò',
        'railway': 'üöÇ',
    }
    
    def __init__(self, use_colors=True):
        super().__init__()
        self.use_colors = use_colors
        
    def format(self, record):
        # Basis-Style f√ºr das Level
        level_style = self.LEVEL_STYLES.get(record.levelname, {
            'emoji': 'üìã', 'color': 'white', 'desc': record.levelname
        })
        
        # Logger-spezifisches Emoji
        logger_emoji = self.LOGGER_EMOJIS.get(record.name, 'üì¶')
        
        # Logger-Namen verk√ºrzen f√ºr bessere Lesbarkeit
        logger_name = self._format_logger_name(record.name)
        
        # Nachricht formatieren
        message = record.getMessage()
        
        # Special Message Formatting
        if record.levelname == 'INFO':
            message = self._enhance_info_message(message)
        elif record.levelname == 'ERROR':
            message = self._enhance_error_message(message)
        elif record.levelname == 'WARNING':
            message = self._enhance_warning_message(message)
        
        # Finale Formatierung - ohne Timestamp (Railway f√ºgt eigene hinzu)
        formatted = (
            f"{level_style['emoji']} "
            f"{logger_emoji} "
            f"{logger_name}: "
            f"{message}"
        )
        
        return formatted
    
    def _format_logger_name(self, name):
        """Verk√ºrzt und versch√∂nert Logger-Namen"""
        if name == 'root':
            return 'Bot'
        elif name.startswith('src.'):
            return name.replace('src.', '').title()
        elif name.startswith('discord.'):
            return name.replace('discord.', 'Discord-').title()
        elif name == 'alembic.runtime.migration':
            return 'Migration'
        elif name.startswith('alembic'):
            return 'Alembic'
        else:
            return name.split('.')[-1].title()
    
    def _enhance_info_message(self, message):
        """Verbessert INFO-Nachrichten mit zus√§tzlichen Emojis"""
        if 'Setup' in message or 'setup' in message:
            return f"üîß {message}"
        elif 'geladen' in message or 'loaded' in message:
            return f"‚úÖ {message}"
        elif 'online' in message or 'bereit' in message:
            return f"üöÄ {message}"
        elif 'synchronisiert' in message or 'synced' in message:
            return f"üîÑ {message}"
        elif 'Migration' in message:
            return f"üíæ {message}"
        elif 'Command' in message:
            return f"üéØ {message}"
        else:
            return message
    
    def _enhance_error_message(self, message):
        """Verbessert ERROR-Nachrichten"""
        if 'Extension' in message and 'has no' in message:
            return f"üì¶ Modul-Fehler: {message}"
        elif 'setup' in message:
            return f"‚öôÔ∏è Setup-Fehler: {message}"
        elif 'connection' in message.lower():
            return f"üîå Verbindungs-Fehler: {message}"
        elif 'database' in message.lower() or 'db' in message.lower():
            return f"üíæ Datenbank-Fehler: {message}"
        else:
            return f"üí• {message}"
    
    def _enhance_warning_message(self, message):
        """Verbessert WARNING-Nachrichten"""
        if 'PyNaCl' in message:
            return f"üîä Voice-Warnung: {message}"
        elif 'nicht gesetzt' in message or 'not set' in message:
            return f"‚öôÔ∏è Konfigurations-Warnung: {message}"
        else:
            return f"‚ö†Ô∏è {message}"


class ProgressLogger:
    """Logger f√ºr Fortschritts-Anzeigen und bessere Struktur"""
    
    def __init__(self, logger):
        self.logger = logger
        
    def start_section(self, title, emoji="üîß"):
        """Startet eine neue Sektion mit sch√∂ner Formatierung"""
        border = "=" * 50
        self.logger.info(f"\n{border}")
        self.logger.info(f"{emoji} {title.upper()}")
        self.logger.info(f"{border}")
    
    def step(self, step_num, total_steps, description, emoji="üìù"):
        """Zeigt einen Schritt im Fortschritt an"""
        progress = f"[{step_num}/{total_steps}]"
        self.logger.info(f"{emoji} {progress} {description}")
    
    def success(self, message, emoji="‚úÖ"):
        """Erfolgreiche Vollendung"""
        self.logger.info(f"{emoji} ERFOLGREICH: {message}")
    
    def warning(self, message, emoji="‚ö†Ô∏è"):
        """Warnung mit spezieller Formatierung"""
        self.logger.warning(f"{emoji} ACHTUNG: {message}")
    
    def error(self, message, emoji="‚ùå"):
        """Fehler mit spezieller Formatierung"""
        self.logger.error(f"{emoji} FEHLER: {message}")
    
    def end_section(self, success=True):
        """Beendet eine Sektion"""
        if success:
            self.logger.info("‚úÖ SEKTION ERFOLGREICH ABGESCHLOSSEN\n")
        else:
            self.logger.error("‚ùå SEKTION MIT FEHLERN ABGESCHLOSSEN\n")


def setup_logging(level=logging.INFO, log_to_file=True, enhanced=True):
    """
    Konfiguriert das erweiterte Logging-System f√ºr den Bot
    
    Args:
        level: Logging-Level (default: INFO)
        log_to_file: Ob in Datei geloggt werden soll
        enhanced: Ob das erweiterte sch√∂ne Format verwendet werden soll
    """
    
    # Root Logger konfigurieren
    root_logger = logging.getLogger()
    root_logger.setLevel(level)
    
    # Alle bestehenden Handler entfernen
    for handler in root_logger.handlers[:]:
        root_logger.removeHandler(handler)
    
    # Console Handler
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(level)
    
    if enhanced:
        # Sch√∂ner Unicode-Formatter mit Emojis
        console_formatter = UnicodeFormatter(use_colors=True)
    else:
        # Klassischer Formatter
        console_formatter = logging.Formatter(
            '%(asctime)s | %(levelname)-8s | %(name)-15s | %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
    
    console_handler.setFormatter(console_formatter)
    root_logger.addHandler(console_handler)
    
    # File Handler (optional)
    if log_to_file:
        log_dir = Path("logs")
        log_dir.mkdir(exist_ok=True)
        
        log_file = log_dir / f"bot_{datetime.now().strftime('%Y%m%d')}.log"
        file_handler = logging.FileHandler(log_file, encoding='utf-8')
        file_handler.setLevel(logging.DEBUG)  # Datei bekommt alle Logs
        
        # Datei bekommt Unicode-Format ohne Farben
        file_formatter = UnicodeFormatter(use_colors=False)
        file_handler.setFormatter(file_formatter)
        root_logger.addHandler(file_handler)
    
    # Discord.py Logger anpassen (weniger verbose)
    discord_logger = logging.getLogger('discord')
    discord_logger.setLevel(logging.WARNING)
    
    # Discord HTTP Logs reduzieren (sind sehr verbose)
    http_logger = logging.getLogger('discord.http')
    http_logger.setLevel(logging.ERROR)
    
    # Asyncio Logger anpassen
    asyncio_logger = logging.getLogger('asyncio')
    asyncio_logger.setLevel(logging.WARNING)
    
    # Alembic Logs anpassen
    alembic_logger = logging.getLogger('alembic')
    alembic_logger.setLevel(logging.INFO)
    
    if enhanced:
        # Sch√∂ne Willkommensnachricht
        banner_logger = logging.getLogger('banner')
        banner_logger.info("")
        banner_logger.info("üåü" + "=" * 48 + "üåü")
        banner_logger.info("üåü" + " " * 16 + "PIXEL DISCORD BOT" + " " * 16 + "üåü")
        banner_logger.info("üåü" + "=" * 48 + "üåü")
        banner_logger.info(f"üïê Gestartet am: {datetime.now().strftime('%d.%m.%Y um %H:%M:%S')}")
        banner_logger.info(f"üêç Python Version: {sys.version.split()[0]}")
        banner_logger.info("üåü" + "=" * 48 + "üåü")
        banner_logger.info("")
    else:
        logging.info("üìù Logging-System initialisiert")
    
    return root_logger


def get_logger(name: str) -> logging.Logger:
    """Erstellt einen Logger f√ºr ein spezifisches Modul."""
    return logging.getLogger(name)


def create_progress_logger(name="progress"):
    """Erstellt einen Progress-Logger f√ºr spezielle Fortschritts-Logs"""
    logger = logging.getLogger(name)
    return ProgressLogger(logger)


# Spezielle Logger f√ºr verschiedene Bot-Bereiche
def get_bot_logger(name):
    """Gibt einen konfigurierten Logger f√ºr Bot-Komponenten zur√ºck"""
    return logging.getLogger(f"src.{name}")


def get_system_logger(name):
    """Gibt einen konfigurierten Logger f√ºr System-Komponenten zur√ºck"""
    return logging.getLogger(f"src.systems.{name}")


# Praktische Logging-Funktionen f√ºr h√§ufige Anwendungsf√§lle
def log_startup_step(step_num, total_steps, description):
    """Loggt einen Startup-Schritt"""
    logger = logging.getLogger("startup")
    progress = f"[{step_num}/{total_steps}]"
    logger.info(f"üöÄ {progress} {description}")


def log_cog_loading(cog_name, success=True, error=None):
    """Loggt das Laden eines Cogs"""
    logger = logging.getLogger("cogs")
    if success:
        logger.info(f"‚öôÔ∏è Cog '{cog_name}' erfolgreich geladen")
    else:
        logger.error(f"‚ùå Fehler beim Laden von Cog '{cog_name}': {error}")


def log_system_status(system_name, status, details=None):
    """Loggt System-Status"""
    logger = logging.getLogger("systems")
    if status == "success":
        logger.info(f"‚úÖ System '{system_name}' erfolgreich initialisiert")
        if details:
            logger.info(f"   üìä Details: {details}")
    elif status == "warning":
        logger.warning(f"‚ö†Ô∏è System '{system_name}' mit Warnungen gestartet")
        if details:
            logger.warning(f"   ‚ö†Ô∏è Details: {details}")
    else:
        logger.error(f"‚ùå System '{system_name}' fehlgeschlagen")
        if details:
            logger.error(f"   üí• Details: {details}")


def log_database_operation(operation, success=True, details=None):
    """Loggt Datenbank-Operationen"""
    logger = logging.getLogger("database")
    if success:
        logger.info(f"üíæ Datenbank-Operation '{operation}' erfolgreich")
        if details:
            logger.info(f"   üìä {details}")
    else:
        logger.error(f"‚ùå Datenbank-Operation '{operation}' fehlgeschlagen")
        if details:
            logger.error(f"   üí• {details}")


def log_command_sync(count, sync_type="global", success=True):
    """Loggt Command-Synchronisation"""
    logger = logging.getLogger("commands")
    if success:
        logger.info(f"üéØ {count} Commands erfolgreich synchronisiert ({sync_type})")
    else:
        logger.error(f"‚ùå Fehler bei Command-Synchronisation ({sync_type})")


def log_bot_ready(guild_count, user_count=None):
    """Loggt Bot-Ready-Status"""
    logger = logging.getLogger("bot")
    logger.info(f"ü§ñ Bot ist bereit und online!")
    logger.info(f"üìä Aktiv in {guild_count} Servern")
    if user_count:
        logger.info(f"üë• Erreicht {user_count} Benutzer")
